package com.RESSOURCES_RELATIONNELLES.controllers;

import java.util.Optional;

import org.springframework.stereotype.Controller;
import org.springframework.web.bind.annotation.PostMapping;
import org.springframework.web.bind.annotation.RequestMapping;
import org.springframework.web.bind.annotation.RequestParam;

import com.RESSOURCES_RELATIONNELLES.entities.Exploit;
import com.RESSOURCES_RELATIONNELLES.entities.Ressource;
import com.RESSOURCES_RELATIONNELLES.entities.User;
import com.RESSOURCES_RELATIONNELLES.services.ExploitService;
import com.RESSOURCES_RELATIONNELLES.services.RessourceService;

import jakarta.servlet.http.HttpServletRequest;
import jakarta.servlet.http.HttpSession;

@Controller
@RequestMapping("/exploit")
public class ExploitController {

	private final RessourceService _ressourceService;
	private final ExploitService _exploitService;
	
	public ExploitController(RessourceService ressourceService, ExploitService exploitService) {
		this._ressourceService = ressourceService;
		this._exploitService = exploitService;
	}
	
	@PostMapping("/create")
	public String addExploit(@RequestParam("ressourceId") Long ressourceId, HttpSession session, HttpServletRequest request) {
		
		User user = (User) session.getAttribute("user");

	    if (user == null) {
	        return "redirect:/home";
	    }
	    
	    Optional<Ressource> optionalRessource = _ressourceService.FindById(ressourceId);
	    Ressource ressource = optionalRessource.get();
	    
	    //VÃ©rifier si la ressource est dÃ©jÃ  dans les ressources exploitÃ©es
	    boolean isExploit = _exploitService.getExploitByUserAndRessourceId(user.getId(), ressourceId).isPresent();
	   
	    if(isExploit) {
	    	_exploitService.deleteExploitByUserAndRessource(user.getId(), ressourceId);
	    } else {
	    
	    Exploit exploit = new Exploit();
	    exploit.setUser(user);
	    exploit.setRessource(ressource);

	    _exploitService.save(exploit);
	    
	    }
	    
	 // ðŸ”™ RÃ©cupÃ©ration de lâ€™URL de provenance
	    String referer = request.getHeader("Referer");
	    if (referer != null) {
	        return "redirect:" + referer;
	    }

	    // Fallback au cas oÃ¹ le referer est absent
	    return "redirect:/ressource/" + ressourceId;
	}
	
}
